using nHydrate.Generator.Common.EventArgs;
using nHydrate.Generator.Common.Logging;
using nHydrate.Generator.Common.ProjectItemGenerators;
using nHydrate.Generator.Common.Util;
using System;
using System.Collections.Generic;

namespace nHydrate.Generator.Common.GeneratorFramework
{
    public abstract class GeneratorHelper
    {
        #region Class Members

        protected List<string> _errorList = new List<string>();

        #endregion

        #region Events

        public event ProjectItemGeneratedEventHandler ProjectItemGenerated;
        protected event ProjectItemDeletedEventHandler ProjectItemDeleted;
        protected event ProjectItemGenerationCompleteEventHandler GenerationComplete;
        protected event ProjectItemGeneratedEventHandler ProjectItemGeneratedError;

        protected virtual void OnProjectItemGenerated(object sender, ProjectItemGeneratedEventArgs pigArgs)
        {
            ProjectItemGenerated?.Invoke(sender, pigArgs);
        }

        protected virtual void OnProjectItemDeleted(object sender, ProjectItemDeletedEventArgs pigArgs)
        {
            ProjectItemDeleted?.Invoke(sender, pigArgs);
        }

        protected virtual void OnGenerationComplete(object sender, ProjectItemGenerationCompleteEventArgs args)
        {
            GenerationComplete?.Invoke(sender, args);
        }

        protected virtual void OnProjectItemGeneratedError(object sender, ProjectItemGeneratedEventArgs pigArgs)
        {
            ProjectItemGeneratedError?.Invoke(sender, pigArgs);
        }

        #endregion

        protected abstract string GetExtensionsFolder();

        protected abstract void LogError(string message);

        #region Public Count Methods

        public virtual int GetFileCount(IGenerator generator, List<Type> excludeList)
        {
            var retval = 0;
            try
            {
                var globalCacheFile = new GlobalCacheFile();
                _generator = generator;
                var projectGenerators = GetProjectGenerators(generator);
                var generatorTypes = ReflectionHelper.GetCreatableObjectImplementsInterface(typeof(IProjectItemGenerator), GetExtensionsFolder());
                foreach (var projectGeneratorType in projectGenerators)
                {
                    try
                    {
                        var exclude = false;
                        foreach (var key in globalCacheFile.ExcludeList)
                        {
                            if (key == projectGeneratorType.FullName)
                                exclude = true;
                        }

                        //Check the passed in exclude list
                        if (excludeList.Contains(projectGeneratorType))
                            exclude = true;

                        if (!exclude)
                        {
                            retval += GetFileCount(generator, projectGeneratorType, generatorTypes);
                        }

                    }
                    catch (Exception ex)
                    {
                        System.Diagnostics.Debug.WriteLine(ex);
                        LogError(ex.ToString());
                    }
                }

                System.Diagnostics.Debug.Write(string.Empty);
                return retval;

            }
            catch (Exception ex)
            {
                throw;
            }

        }

        private int GetFileCount(IGenerator generator, Type projectGeneratorType, System.Type[] generatorTypes)
        {
            var retval = 0;
            var projectGenerator = GetProjectGenerator(projectGeneratorType);
            projectGenerator.Initialize(generator.Model);
            retval += GetFileCount(projectGenerator, generatorTypes);
            retval += 1; // The actual project file it self
            return retval;
        }

        private int GetFileCount(IProjectGenerator projectGenerator, System.Type[] generatorTypes)
        {
            var retval = 0;
            var projectItemGenerators = GetProjectItemGenerators(projectGenerator);
            foreach (var projectItemGeneratorType in projectItemGenerators)
            {
                try
                {
                    retval += GetFileCount(projectItemGeneratorType, generatorTypes);
                }
                catch (Exception ex)
                {
                    nHydrateLog.LogWarning(ex);
                }
            }
            return retval;
        }

        private int GetFileCount(Type projectItemGeneratorType, System.Type[] generatorTypes)
        {
            var retval = 0;
            var projectItemGenerator = GetProjectItemGenerator(projectItemGeneratorType);
            projectItemGenerator.Initialize(_generator.Model);
            retval += GetFileCount(projectItemGenerator, generatorTypes);
            return retval;
        }

        private int GetFileCount(IProjectItemGenerator projectItemGenerator, System.Type[] generatorTypes)
        {
            var retval = 0;
            try
            {
                retval += projectItemGenerator.FileCount;

                foreach (var type in generatorTypes)
                {
                    var subProjectItemGenerator = GetProjectItemGenerator(type);
                    var genItemAttribute = (GeneratorItemAttribute)ReflectionHelper.GetSingleAttribute(typeof(GeneratorItemAttribute), subProjectItemGenerator);
                    if (genItemAttribute != null && genItemAttribute.ParentType == projectItemGenerator.GetType())
                    {
                        subProjectItemGenerator.Initialize(_generator.Model);
                        retval += GetFileCount(subProjectItemGenerator, generatorTypes);
                    }
                }

                return retval;
            }
            catch (Exception ex)
            {
                _errorList.Add(ex.ToString());
                nHydrateLog.LogError(ex);
                throw;
            }
        }

        #endregion

        #region Public Generate Methods

        protected IGenerator _generator;
        public virtual void GenerateAll(IGenerator generator, List<Type> excludeList)
        {
            var globalCacheFile = new GlobalCacheFile();
            _generator = generator;
            var projectGenerators = GetProjectGenerators(generator);
            Console.WriteLine($"Generator count: {projectGenerators.Count}");
            Console.WriteLine();

            foreach (var projectGeneratorType in projectGenerators)
            {
                try
                {
                    var exclude = false;
                    foreach (var key in globalCacheFile.ExcludeList)
                    {
                        if (key == projectGeneratorType.FullName)
                            exclude = true;
                    }

                    //Check the passed in exclude list
                    if (excludeList.Contains(projectGeneratorType))
                        exclude = true;

                    if (!exclude)
                    {
                        GenerateProject(generator, projectGeneratorType);
                    }

                }
                catch (Exception ex)
                {
                    System.Diagnostics.Debug.WriteLine(ex);
                    LogError(ex.ToString());
                }
            }
            System.Diagnostics.Debug.Write(string.Empty);
        }

        protected abstract void GenerateProject(IGenerator generator, Type projectGeneratorType);

        protected abstract IProjectGeneratorProjectCreator GetProjectGeneratorProjectCreator(string outputFolder);

        protected void CreateProject(IGenerator generator, Type projectGeneratorType, string outputFolder)
        {
            var projectGenerator = GetProjectGenerator(projectGeneratorType);

            //For the VSIX modeler, this is the object that will create project in Visual Studio
            (projectGenerator as IProjectGenerator).ProjectGeneratorProjectCreator = GetProjectGeneratorProjectCreator(outputFolder);

            projectGenerator.Initialize(generator.Model);
            projectGenerator.CreateProject();
        }

        public IProjectGenerator GetProjectGenerator(Type projectGeneratorType)
        {
            return (IProjectGenerator)ReflectionHelper.CreateInstance(projectGeneratorType);
        }
        protected IProjectItemGenerator GetProjectItemGenerator(Type projectItemGeneratorType)
        {
            return (IProjectItemGenerator)ReflectionHelper.CreateInstance(projectItemGeneratorType);
        }

        protected void GenerateProjectItems(IProjectGenerator projectGenerator)
        {
            var projectItemGenerators = GetProjectItemGenerators(projectGenerator);
            foreach (var projectItemGeneratorType in projectItemGenerators)
            {
                try
                {
                    GenerateProjectItems(projectItemGeneratorType);
                }
                catch (Exception ex)
                {
                    nHydrateLog.LogWarning(ex);
                }
            }
        }

        protected void GenerateSubItems(IProjectItemGenerator projectItemGenerator)
        {
            var projectItemGenerators = GetProjectItemGenerators(projectItemGenerator);
            foreach (var projectItemGeneratorType in projectItemGenerators)
            {
                try
                {
                    GenerateProjectItems(projectItemGeneratorType);
                }
                catch (Exception ex)
                {
                    nHydrateLog.LogWarning(ex);
                }
            }
        }

        private void GenerateProjectItems(Type projectItemGeneratorType)
        {
            var projectItemGenerator = GetProjectItemGenerator(projectItemGeneratorType);
            projectItemGenerator.Initialize(_generator.Model);
            GenerateProjectItems(projectItemGenerator);
        }

        protected abstract void projectItemGenerator_ProjectItemGenerated(object sender, ProjectItemGeneratedEventArgs e);
        protected abstract void projectItemGenerator_ProjectItemDeleted(object sender, ProjectItemDeletedEventArgs e);
        protected abstract void projectItemGenerator_ProjectItemGenerationError(object sender, ProjectItemGeneratedErrorEventArgs e);
        protected abstract void projectItemGenerator_ProjectItemExists(object sender, ProjectItemExistsEventArgs e);

        private void GenerateProjectItems(IProjectItemGenerator projectItemGenerator)
        {
            try
            {
                projectItemGenerator.GenerationComplete += new ProjectItemGenerationCompleteEventHandler(projectItemGenerator_GenerationComplete);
                projectItemGenerator.ProjectItemGenerated += new ProjectItemGeneratedEventHandler(projectItemGenerator_ProjectItemGenerated);
                projectItemGenerator.ProjectItemDeleted += new ProjectItemDeletedEventHandler(projectItemGenerator_ProjectItemDeleted);
                projectItemGenerator.ProjectItemExists += new ProjectItemExistsEventHandler(projectItemGenerator_ProjectItemExists);
                projectItemGenerator.ProjectItemGenerationError += new ProjectItemGeneratedErrorEventHandler(projectItemGenerator_ProjectItemGenerationError);
                projectItemGenerator.Generate();
            }
            catch (Exception ex)
            {
                _errorList.Add(ex.ToString());
                nHydrateLog.LogError(ex);
                throw;
            }
        }

        public List<Type> GetProjectGenerators(IGenerator generator) => GetGeneratorsImpl(generator);

        protected List<Type> GetProjectItemGenerators(IProjectGenerator projectGenerator) => GetGeneratorsImpl(projectGenerator);

        private List<Type> GetProjectItemGenerators(IProjectItemGenerator projectItemGenerator) => GetGeneratorsImpl(projectItemGenerator);
        #endregion

        #region Private Helpers

        protected readonly List<string> processedFiles = new List<string>();

        /// <summary>
        /// Gets the errors that have occured since object instantiation
        /// </summary>
        /// <returns></returns>
        public IEnumerable<string> GetErrorList() => _errorList;

        private void projectItemGenerator_GenerationComplete(object sender, ProjectItemGenerationCompleteEventArgs e)
        {
            nHydrateLog.LogInfo("Project Item Generation Complete: {0}", e.ProjectItemGenerator);
            try
            {
                GenerateSubItems(e.ProjectItemGenerator);
                this.OnGenerationComplete(sender, e);
            }
            catch (Exception ex)
            {
                nHydrateLog.LogWarning(ex);
            }
        }

        private readonly Dictionary<object, List<Type>> _detGeneratorsImplCache = new Dictionary<object, List<Type>>();
        private List<Type> GetGeneratorsImpl(object parent)
        {
            if (_detGeneratorsImplCache.ContainsKey(parent))
                return _detGeneratorsImplCache[parent];

            var returnVal = new List<Type>();
            Type[] generatorTypes = null;
            if (ReflectionHelper.ImplementsInterface(parent, typeof(IGenerator)))
                generatorTypes = ReflectionHelper.GetCreatableObjectImplementsInterface(typeof(IProjectGenerator), GetExtensionsFolder());
            else
                generatorTypes = ReflectionHelper.GetCreatableObjectImplementsInterface(typeof(IProjectItemGenerator), GetExtensionsFolder());

            if (generatorTypes.Length == 0)
                LogError($"There are no generators installed or there was an error loading the installed generators from the following path. '{GetExtensionsFolder()}'");

            foreach (var type in generatorTypes)
            {
                var genItemAttribute = (GeneratorItemAttribute)ReflectionHelper.GetSingleAttribute(typeof(GeneratorItemAttribute), type);
                if (genItemAttribute != null && genItemAttribute.ParentType == parent.GetType())
                {
                    returnVal.Add(type);
                }
            }

            //Cache this for next time
            _detGeneratorsImplCache.Add(parent, returnVal);
            return returnVal;

        }

        #endregion
    }
}
